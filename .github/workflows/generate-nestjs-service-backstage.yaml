name: Run CLI NestJS

on:
  workflow_dispatch:
    inputs:
      execution_id:
        description: "Execution identifier"
        required: true
        type: string
      project_name:
        description: "Target repository name"
        required: true
        type: string
      target_branch:
        description: "Target branch"
        required: true
        type: string
      args:
        description: "JSON string containing component configurations"
        required: true
        default: "{}"
        type: string

run-name: ${{ github.event.inputs.execution_id }}

jobs:
  run-cli:
    name: Run CLI
    runs-on: ubuntu-latest
    timeout-minutes: 1
          
    steps:

      # ─────────────────────────────────────────────────────────────────────────
      # Setup Python (for running Python scripts)
      # ─────────────────────────────────────────────────────────────────────────
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'
          # No cache needed since we only use standard library modules
  
      # ─────────────────────────────────────────────────────────────────────────
      # Parse and validate inputs (Python Script)
      # ─────────────────────────────────────────────────────────────────────────
      - name: Parse and validate inputs
        id: inputs
        env:
          JSON_ARGS: ${{ inputs.args }}

        run: |
          ls \
          python3 .github/workflow/scripts/nestjs-service-generator/validator.py \
            --project-name "${{ inputs.project_name }}" \
            --execution-id "${{ inputs.execution_id }}" \
            --args "$JSON_ARGS" \
            --target-branch "${{ inputs.target_branch }}" \
            --description "${{ inputs.description }}" \
            --author "${{ inputs.author }}" \
            ${{ inputs.with_examples && '--with-examples' || '' }} \
            --target-org "${{ env.TARGET_ORG }}" \
            --generator-name "${{ env.GENERATOR_NAME }}" \
            --output-format github > /tmp/validator_output.txt
  
          # Extract outputs from the script output (key=value format)
          grep "^[a-z_]*=" /tmp/validator_output.txt | while IFS='=' read -r key value; do
            echo "${key}=${value}" >> "$GITHUB_OUTPUT"
          done
  
          # Display summary
          grep -A 100 "^### Configuration" /tmp/validator_output.txt >> "$GITHUB_STEP_SUMMARY" || true
    
      - name: Print Raw Input
        run: |
          echo "Received raw JSON:"
          echo '${{ github.event.inputs.args }}'

      - name: Parse and Print Specific Values
        run: |
          timeout 60s bash -c '
            REPOSITORY_NAME="${{ github.event.inputs.project_name }}"
            EXECUTION_ID="${{ github.event.inputs.execution_id }}"
            COMPONENTS="${{ github.event.inputs.args }}"

            echo "Repository Name: $REPOSITORY_NAME"
            echo "Execution ID: $EXECUTION_ID"

            REST_STATUS=$(echo "$COMPONENTS" | jq -r ".rest.enabled")
            GQL_STATUS=$(echo "$COMPONENTS" | jq -r ".graphql.enabled")
            PG_HEALTH=$(echo "$COMPONENTS" | jq -r ".postgres.healthCheck")
            REDIS_HEALTH=$(echo "$COMPONENTS" | jq -r ".redis.healthCheck")

            echo "---------------------------------------"
            echo "Rest Enabled: $REST_STATUS"
            echo "GraphQL Enabled: $GQL_STATUS"
            echo "Postgres HealthCheck: $PG_HEALTH"
            echo "Redis HealthCheck: $REDIS_HEALTH"
            echo "---------------------------------------"
          '

      - name: Conditional Step Example
        if: ${{ fromJson(github.event.inputs.args).graphql.enabled == true }}
        run: echo "GraphQL is enabled. Performing GraphQL specific tasks..."

      # - name: Force failure (test)
      #   run: |
      #     echo "Forcing workflow failure for test"
      #     exit 1
